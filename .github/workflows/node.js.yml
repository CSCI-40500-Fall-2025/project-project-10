# This workflow runs tests and triggers Vercel deployment
# Frontend tests run first, then backend build is verified before deployment

name: CI and Deploy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  # Step 0: Add .env files from the repo secrets
  add-secrets:
    name: Add Secrets to Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
  
      - name: Add FrontEnd DotEnv
        working-directory: ./client
        run: echo VITE_API_URL=${{secrets.API_URL}} > ./dist/.env

      - name: Add BackEnd DotEnv
        working-directory: ./server
        run: echo DATABASE_URL=${{secrets._URL}} > ./dist/.env

  # Step 1: Run client tests
  client-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: client/package-lock.json
          
      - name: Sync npm packages
        working-directory: ./client
        run: npm install
        
      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Run client tests
        working-directory: ./client
        run: npm run test

      - name: Build client (verification)
        working-directory: ./client
        run: npm run build

  # Step 2: Verify server builds (runs after client tests pass)
  server-build:
    name: Backend Build Verification
    needs: client-tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Build server (TypeScript compilation)
        working-directory: ./server
        run: npm run build

      - name: Verify build output exists
        run: |
          if [ ! -f "server/dist/index.js" ]; then
            echo "[ERROR] Server build failed - dist/index.js not found"
            exit 1
          fi
          echo "[SUCCESS] Server build successful"

  # Step 3: Deploy to Vercel (only on push to main, after all tests pass)
  deploy:
    name: Deploy to Vercel
    needs: [client-tests, server-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Vercel deploy hooks are configured
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.VERCEL_FRONTEND_DEPLOY_HOOK }}" ]; then
            MISSING_SECRETS+=("VERCEL_FRONTEND_DEPLOY_HOOK")
          fi
          
          if [ -z "${{ secrets.VERCEL_BACKEND_DEPLOY_HOOK }}" ]; then
            MISSING_SECRETS+=("VERCEL_BACKEND_DEPLOY_HOOK")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "[WARNING] Missing secrets: ${MISSING_SECRETS[*]}"
            echo "Please add them in: Settings -> Secrets -> Actions"
            exit 1
          fi

      - name: Trigger Frontend deployment
        run: |
          echo "[DEPLOY] Triggering Frontend (client) deployment..."
          RESPONSE=$(curl -X POST "${{ secrets.VERCEL_FRONTEND_DEPLOY_HOOK }}" \
            --write-out "\n%{http_code}" \
            --silent \
            --show-error)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "[SUCCESS] Frontend deployment triggered (HTTP $HTTP_CODE)"
          else
            echo "[ERROR] Frontend deployment failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Trigger Backend deployment
        run: |
          echo "[DEPLOY] Triggering Backend (server) deployment..."
          RESPONSE=$(curl -X POST "${{ secrets.VERCEL_BACKEND_DEPLOY_HOOK }}" \
            --write-out "\n%{http_code}" \
            --silent \
            --show-error)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "[SUCCESS] Backend deployment triggered (HTTP $HTTP_CODE)"
          else
            echo "[ERROR] Backend deployment failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "## Deployments Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [PASS] Frontend tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [PASS] Backend build verified" >> $GITHUB_STEP_SUMMARY
          echo "- [PASS] Frontend deployment initiated" >> $GITHUB_STEP_SUMMARY
          echo "- [PASS] Backend deployment initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check deployment status in [Vercel Dashboard](https://vercel.com/dashboard)" >> $GITHUB_STEP_SUMMARY
